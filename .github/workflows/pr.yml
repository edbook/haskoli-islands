name: Pull Request

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
  issues: write

concurrency:
  group: "pr-${{ github.event.pull_request.number }}"
  cancel-in-progress: true

on:
  pull_request:
    branches: [main, conda]
    types: [opened, synchronize, labeled]
    paths:
      - "projects/**"
      - "cli/**"
      - ".github/**"

jobs:
  build-docs:
    name: Build PR Documentation
    uses: ./.github/workflows/build-docs-optimized.yml
    with:
      environment_name: ${{ github.head_ref }}
      deployment_type: pr
    permissions:
      contents: read
      pages: write
      id-token: write

  announce-url:
    name: Announce feature url
    runs-on: ubuntu-latest
    needs: build-docs
    steps:
      - name: Find Comment
        uses: peter-evans/find-comment@v2
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: Your deployment is here

      - name: Create comment
        if: steps.fc.outputs.comment-id == ''
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ“š PR Documentation Deployed
            
            Your PR documentation is available with enhanced build performance:
            
            **ğŸ”— PR Documentation:** ${{ needs.build-docs.outputs.deploy-url }}${{ github.head_ref }}/
            **ğŸ”— Individual Projects:** Available at ${{ needs.build-docs.outputs.deploy-url }}${{ github.head_ref }}/[project-name]/
            
            **âœ¨ Performance Features:**
            - âš¡ Parallel builds (4x faster)
            - ğŸ’¾ Intelligent caching
            - ğŸ—ï¸ Optimized Sphinx configuration
            - ğŸ“Š Build statistics included
            
            **Version:** `${{ needs.build-docs.outputs.version }}`
          reactions: rocket

  notify-discord-pr:
    name: Notify Discord (open PR)
    runs-on: ubuntu-20.04
    needs: [build-docs]
    if: github.event.action == 'opened'
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
      - name: Notify open PR
        run: |
          content_title="NÃ½tt PR opnaÃ°"
          title="${{ github.event.pull_request.title }}"
          color=2061822
          description="${{ github.event.pull_request.body }}"
          url=${{ github.event.pull_request.html_url }}
          author_name=${{ github.event.pull_request.user.login}}
          author_url=${{ github.event.pull_request.user.url}}
          author_avatar=${{ github.event.pull_request.user.avatar_url}}
          branch=${{ github.head_ref }}

          payload=$(cat <<EOF
          {
            "content": "$content_title",
            "avatar_url": "https://www.shareicon.net/data/128x128/2015/08/28/92005_social-media_512x512.png",
            "embeds": [
              {
                "title": "$title",
                "description": "$description",
                "url": "$url",
                "color": $color,
                "fields": [
                  {
                    "name": "Build Performance",
                    "value": "âš¡ Parallel builds enabled"
                  },
                  {
                    "name": "url",
                    "value": "[SkoÃ°a Ã¡ edbook](${{ needs.build-docs.outputs.deploy-url }}${branch})"
                  }
                ],
                "author": {
                  "name": "$author_name",
                  "url": "$author_url",
                  "icon_url": "$author_avatar"
                }
              }
            ]
          }
          EOF
          )
          ./.github/discord.sh  \
            -w ${{ secrets.DISCORD_WEBHOOK }} \
            -c "$payload"