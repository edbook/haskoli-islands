name: Pull Request Merge

on:
  pull_request:
    types: [closed]
    branches: [main, conda]

jobs:
  notify-discord-merge:
    name: Notify Discord (merged PR)
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Notify merge
        run: |
          content_title="N√Ω √∫tg√°fa er kominn √≠ lofti√∞ üéâ"
          title="${{ github.base_ref }} ‚Ü©Ô∏è ${{ github.head_ref }}"
          color=32768
          description="${{ github.event.pull_request.body }}"
          url=${{ github.event.pull_request.html_url }}
          author_name=${{ github.event.pull_request.user.login}}
          author_url=${{ github.event.pull_request.user.url}}
          author_avatar=${{ github.event.pull_request.user.avatar_url}}
          branch=${{ github.head_ref }}

          payload=$(cat <<EOF
          {
            "content": "$content_title",
            "avatar_url": "https://www.shareicon.net/data/128x128/2015/08/28/92005_social-media_512x512.png",
            "embeds": [
              {
                "title": "$title",
                "description": "$description",
                "url": "$url",
                "color": $color,
                "fields": [
                  {
                    "name": "url",
                    "value": "[Sko√∞a √° edbook](https://edbook.hi.is)"
                  }
                ],
                "author": {
                  "name": "$author_name",
                  "url": "$author_url",
                  "icon_url": "$author_avatar"
                }
              }
            ]
          }
          EOF
          )
          ./.github/discord.sh  \
            -w ${{ secrets.DISCORD_WEBHOOK }} \
            -c "$payload"